import asyncio
from datetime import datetime, time, timedelta
from zoneinfo import ZoneInfo
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackContext, MessageHandler, filters

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_states = {}  # user_id: True/False


async def send_water_message(application: Application):
    tz = ZoneInfo("Europe/Chisinau")

    while True:
        now = datetime.now(tz)

        start = time(8, 0)
        end = time(20, 0)

        if start <= now.time() <= end:
            # –†–∞—Å—Å—ã–ª–∞–µ–º "–≤–æ–¥–∞" —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            for user_id, enabled in user_states.items():
                if enabled:
                    try:
                        await application.bot.send_message(chat_id=user_id, text="üíß –í–æ–¥–∞")
                    except Exception:
                        pass

        # –ñ–¥—ë–º 5 –º–∏–Ω—É—Ç
        await asyncio.sleep(300)


def get_keyboard():
    return ReplyKeyboardMarkup(
        [["–í–ö–õ", "–í–´–ö–õ"]],
        resize_keyboard=True
    )


async def start(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    user_states[user_id] = True

    await update.message.reply_text(
        "–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.\n"
        "–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç —Å 08:00 –¥–æ 20:00 —è –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å '–≤–æ–¥–∞'.",
        reply_markup=get_keyboard()
    )


async def buttons(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    text = update.message.text.strip().lower()

    if text == "–≤–∫–ª":
        user_states[user_id] = True
        await update.message.reply_text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –í–ö–õ–Æ–ß–ï–ù–´ ‚úîÔ∏è")
    elif text == "–≤—ã–∫–ª":
        user_states[user_id] = False
        await update.message.reply_text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –í–´–ö–õ–Æ–ß–ï–ù–´ ‚ùå")
    else:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –í–ö–õ / –í–´–ö–õ.")


async def main():
    application = Application.builder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, buttons))

    # –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    asyncio.create_task(send_water_message(application))

    await application.run_polling()


if __name__ == "__main__":
    asyncio.run(main())
